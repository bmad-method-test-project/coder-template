name: Deploy Coder Template (Terraform)
run-name: "Deploy Coder Template - Version: ${{ github.event.release.tag_name || github.ref_name }}"

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  # Coder instance configuration
  CODER_URL: ${{ vars.CODER_URL }}
  # Terraform variables
  TF_VAR_namespace: ${{ vars.CODER_NAMESPACE }}
  TF_VAR_use_kubeconfig: ${{ vars.USE_KUBECONFIG }}
  TF_VAR_bmad_cli_version: ${{ vars.BMAD_CLI_VERSION }}

jobs:
  deploy-template:
    name: Deploy Template with Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.ref }}

      - name: Read VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Template version: $VERSION"

      - name: Determine version name
        id: version_info
        env:
          GITHUB_TOKEN: ${{ github.token }}
          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          # Use release tag if available, otherwise use VERSION file
          if [ "${GITHUB_EVENT_NAME}" = "release" ] && [ -n "${RELEASE_TAG_NAME}" ]; then
            VERSION_NAME="${RELEASE_TAG_NAME}"
          else
            VERSION_NAME="${{ steps.version.outputs.VERSION }}"
          fi
          
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Version name: ${VERSION_NAME}"

      - name: Extract PR title for version message
        id: pr_info
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.groot-preview+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls")

          PR_TITLE=$(echo "$RESPONSE" | jq -r '.[0].title // empty')

          if [ -z "$PR_TITLE" ]; then
            PR_TITLE=$(git show -s --format=%s "${GITHUB_SHA}")
          fi

          # Truncate to 72 characters (coderd limit)
          PR_TITLE_SHORT=$(echo "$PR_TITLE" | cut -c1-72)
          
          echo "pr_title=${PR_TITLE_SHORT}" >> $GITHUB_OUTPUT
          echo "ðŸ’¬ Version message: ${PR_TITLE_SHORT}"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ">= 1.2"
          terraform_wrapper: false

      - name: Validate workspace template
        run: |
          echo "ðŸ” Validating workspace template..."
          terraform init -backend=false
          
          # Show formatting diffs but don't fail on fmt issues
          if ! terraform fmt -check -diff -recursive; then
            echo "::warning title=Terraform formatting::Some files need 'terraform fmt -recursive'"
          fi
          
          terraform validate
          echo "âœ… Workspace template validation successful"

      - name: Create Terraform variables file
        working-directory: management
        env:
          VERSION_NAME: ${{ steps.version_info.outputs.version_name }}
          VERSION_MESSAGE: ${{ steps.pr_info.outputs.pr_title }}
        run: |
          cat > terraform.tfvars <<EOF
          # Auto-generated by GitHub Actions
          # Version: ${VERSION_NAME}
          # Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          version_name      = "${VERSION_NAME}"
          version_message   = "${VERSION_MESSAGE}"
          version_is_active = true
          
          namespace        = "${TF_VAR_namespace}"
          use_kubeconfig   = ${TF_VAR_use_kubeconfig}
          bmad_cli_version = "${TF_VAR_bmad_cli_version}"
          EOF
          
          echo "ðŸ“ Created terraform.tfvars:"
          cat terraform.tfvars

      - name: Initialize Terraform
        working-directory: management
        env:
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          terraform init
          echo "âœ… Terraform initialized"

      - name: Plan Terraform changes
        working-directory: management
        env:
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          terraform plan -out=tfplan
          echo "ðŸ“‹ Terraform plan created"

      - name: Apply Terraform changes
        working-directory: management
        env:
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          terraform apply -auto-approve tfplan
          echo "âœ… Template deployed successfully!"

      - name: Get deployment outputs
        working-directory: management
        env:
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          echo "ðŸ“Š Deployment Information:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          TEMPLATE_ID=$(terraform output -raw template_id)
          TEMPLATE_NAME=$(terraform output -raw template_name)
          TEMPLATE_URL=$(terraform output -raw template_url)
          
          echo "ðŸ“¦ Template ID: ${TEMPLATE_ID}"
          echo "ðŸ·ï¸  Template Name: ${TEMPLATE_NAME}"
          echo "ðŸ”— Template URL: ${CODER_URL}/templates/${TEMPLATE_URL}"
          echo "ðŸ“Œ Version: ${{ steps.version_info.outputs.version_name }}"
          echo "ðŸ’¬ Message: ${{ steps.pr_info.outputs.pr_title }}"
          
          # Set outputs for job summary
          echo "TEMPLATE_ID=${TEMPLATE_ID}" >> $GITHUB_ENV
          echo "TEMPLATE_NAME=${TEMPLATE_NAME}" >> $GITHUB_ENV
          echo "TEMPLATE_URL=${TEMPLATE_URL}" >> $GITHUB_ENV

      - name: Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Template Deployment Summary
          
          ### Template Information
          - **Name**: \`${TEMPLATE_NAME}\`
          - **Version**: \`${{ steps.version_info.outputs.version_name }}\`
          - **ID**: \`${TEMPLATE_ID}\`
          
          ### Version Details
          - **Message**: ${{ steps.pr_info.outputs.pr_title }}
          - **Deployed**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: \`${GITHUB_SHA:0:7}\`
          
          ### Configuration
          - **Namespace**: \`${TF_VAR_namespace}\`
          - **Use Kubeconfig**: \`${TF_VAR_use_kubeconfig}\`
          - **BMAD CLI Version**: \`${TF_VAR_bmad_cli_version}\`
          
          ### Links
          - [View Template in Coder](${CODER_URL}/templates/${TEMPLATE_URL})
          - [Workflow Run](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})
          
          ---
          *Deployed with Terraform via coderd provider*
          EOF
